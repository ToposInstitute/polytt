def id : (A : Type) â†’ A â†’ A :=
  Î» A x â†’ x

def id_ : (A : Type) â†’ A â†’ A :=
  Î» A x â†’ x

def const : (A : Type) â†’ (B : Type) â†’ A â†’ B â†’ A :=
  Î» _ _ x _ â†’ x

def four : â„• := 4

def double : â„• â†’ â„• :=
  Î» n â†’ elim (Î» _ â†’ â„•) 0 (Î» _ â†’ Î» n â†’ succ (succ n)) n

def add : â„• â†’ â„• â†’ â„• :=
  Î» m n â†’ elim (Î» _ â†’ â„•) n (Î» _ n â†’ succ n) m

def sigma : (A : Type) â†’ (A â†’ Type) â†’ Type :=
  Î» A â†’ Î» B â†’ (x : A) Ã— B x

def dup : (A : Type) â†’ A â†’ (A Ã— A) :=
  Î» _ a â†’ (a , a)

def pair : â„• â†’ â„• â†’ (_ : â„•) Ã— â„• :=
  Î» n m â†’ (n , m : â„•)

def projl : (â„• Ã— â„•) â†’ â„• :=
  Î» x â†’ fst x

def Bool := #{ .true, .false }

def Unit := (t : #{}) -> ({} : #{} -> Type) t

def unit : Unit := {}

def ARecord := { .true : â„•, .false : Bool }

def record_lit : ARecord := { .true = 0, .false = .true }

def Anything := (T : Type) * T

def let-example :=
  let n = 5 : â„•
  in n

#normalize let-example

def nyan : Poly :=
  (â„• Ã— â„•)

def tensor : Poly â†’ Poly â†’ Poly :=
  Î» P Q â†’ (pq : base P Ã— base Q) Ã— (fib P (fst pq) Ã— fib Q (snd pq))

#normalize base (tensor nyan nyan)
#normalize fib (tensor nyan nyan) (1 , 2)


def id : (P : Poly) â†’ P â‡’ P :=
  Î» P â†’ Î» aâº aâ» â‡
    aâº â‡œ aâ»

#print (Î» P â†’ P) : Poly â†’ Poly

#print (Î» P â†’ Î» aâº aâ» â‡ aâº â‡œ aâ») : (P : Poly) â†’ P â‡’ P

def nyan-hom : â„• â†’ nyan â‡’ nyan :=
  Î» n â†’ Î» aâº aâ» â‡
    (aâº , aâ») â¤š (id nyan) â†’ (bâº , bâ»);
    n â‡œ (bâ» âˆ˜ succ âˆ˜ succ)

#normalize nyan-hom 42 1

def nyan-hom2 : nyan â‡’ nyan :=
  Î» aâº aâ» â‡
    (aâº , aâ») â¤š (nyan-hom 12) â†’ (bâº , bâ»);
    bâº â‡œ bâ»

#normalize nyan-hom2 1

def compose : (P : Poly) â†’ (Q : Poly) â†’ (R : Poly) â†’ Q â‡’ R â†’ P â‡’ Q â†’ P â‡’ R :=
  Î» P Q R f g â†’ Î» pâº pâ» â‡
    (pâº , pâ») â¤š g â†’ (qâº , qâ»);
    (qâº , qâ») â¤š f â†’ (râº , râ»);
    râº â‡œ râ»


-- ğŸˆğŸŒˆ
#normalize (compose nyan nyan nyan nyan-hom2 nyan-hom2) 1

def counter : (â„• Ã— â„•) â‡’ (â„• Ã— #{ .single }) :=
  Î» nâº nâ» â‡
    nâº â‡œ (nâ» âˆ˜ (const â„• #{ .single } (succ nâº)))

#normalize counter

def Moore : Type â†’ Type â†’ Type â†’ Type :=
  Î» S I O â†’ (S Ã— S) â‡’ (O Ã— I)

def mds : (A : Type) â†’ (B : Type) â†’ (A â†’ B) â†’ Moore B A B :=
  Î» A B f â†’ Î» bâº bâ» â‡
    bâº â‡œ (bâ» âˆ˜ f)

def Gate : Type â†’ Type â†’ Type :=
  Î» I O â†’ Moore O I O

def test-pair : nyan â‡’ (tensor nyan nyan) :=
  Î» nâº nâ» â‡
    (nâº , nâ») â¤š (nyan-hom 12) â†’ (bâº , bâ»);
    ((nâº , bâº)) â‡œ [! , Î» _ â†’ bâ» âˆ˜ succ]

#normalize (test-pair 1)

def swap : (P : Poly) â†’ (Q : Poly) â†’ tensor P Q â‡’ tensor Q P :=
  Î» P Q â†’ Î» pqâº pqâ» â‡
    pqâ» â†’ (pâ» , qâ»);
    ((snd pqâº , fst pqâº)) â‡œ [qâ» , Î» _ â†’ pâ»]

-- Î» (pâº, qâº) (pâ», qâ») â‡ (qâº , pâº) , (qâ» , pâ»)

#normalize swap nyan nyan (1, 2)

def internal-hom : Poly â†’ Poly â†’ Poly :=
  Î» P Q â†’ (f : P â‡’ Q) Ã— ((p : base P) Ã— fib Q (fst (f p)))

    -- ? â†’ (qâ» âˆ˜ (snd ((snd pfâº) (fst pfâº))));
    -- (fst pfâº , pâ») â¤š (snd pfâº) â†’ (qâ‚âº , qâ‚â»);
    -- (fst pfâº) â†’ pbâ»;
    -- qâ‚âº â‡œ qâ‚â»

def eval : (P : Poly) â†’ (Q : Poly) â†’ tensor P (internal-hom P Q) â‡’ Q :=
  Î» P Q â†’ Î» pfâº pfâ» â‡
    let pâº = fst pfâº;
    let fâº = snd pfâº;
    let qfâº = fâº pâº;
    let qâº = fst qfâº;
    pfâ» â†’ (pâ» , fâ»);
    fâ» â†’ (pbâ» , qâ»);
    (fst pfâº) â†’ pbâ»;
    letâ» qfâ» = Î»â» (v : fib Q qâº) â†’
      -- ignore this id_ ?, parsing bug
      (id_ (fib Q qâº) v) â†’ qâ»;
      ((snd qfâº) v) â†’ pâ»;
      end;
    (fst qfâº) â‡œ qfâ»
    -- the following crashes due to bug :(
--    (fst qfâº) â‡œ Î»â» (v : fib Q qâº) â†’
--      -- ignore this id_ ?, parsing bug
--      (id_ (fib Q qâº) v) â†’ qâ»;
--      ((snd qfâº) v) â†’ pâ»;
--      end

#normalize (eval nyan nyan) (3 , nyan-hom 12)

def compose : Poly â†’ Poly â†’ Poly :=
  Î» P Q â†’ (pf : (p : base P) Ã— (fib P p â†’ base Q)) Ã— (i : fib P (fst pf)) Ã— fib Q ((snd pf) i)

def tensor-to-compose : (P : Poly) â†’ (Q : Poly) â†’ tensor P Q â‡’ compose P Q :=
  Î» P Q â†’ Î» pqâº pqâ» â‡
    (fst pqâº , Î» _ â†’ snd pqâº) â‡œ pqâ»


